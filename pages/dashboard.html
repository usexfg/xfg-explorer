<div class="slim-mainpanel">
  <div class="container pd-t-30">

    <div class="dash-headline-two" id="welcomeSection">
      <div>
        <h4 class="tx-white mg-b-5" tkey="welcome">Welcome</h4>
        <p class="mg-b-0" id="currentDate"></p>
      </div>
    </div><!-- dash-headline-two -->

    <div class="card card-dash-one mg-t-20">
      <div class="row no-gutters">
        <div class="col-lg-4">
          <div class="dash-content">
            <label class="tx-primary" tkey="totalBanked">Total Banked</label>
            <label class="tx-primary" id="depositCoinsPct"></label><BR>
            <label href="http://cold.usexfg.org" class="tx-secondary">The total amount of TEST in COLD</label>
            <h2><span id="depositCoins">N/A</span></h2>
          </div><!-- dash-content -->
        </div><!-- col-4 -->
        <div class="col-lg-4">
          <div class="dash-content dash-small-info">
            <label class="tx-primary" tkey="circulatingSupply">Circulating Supply</label>
            <label class="tx-primary" id="emissionPercentPct"></label><BR>
            <label class=" tx-secondary" tkey="circulatingSuppyInfo">The total active TEST not banked.</label>
            <h2><span id="emissionPercent">N/A</span></h2>
          </div><!-- dash-content -->
        </div><!-- col-4 -->
        <div class="col-lg-4">
        <div class="dash-content dash-small-info">
            <label class="tx-primary" tkey="totalSupply">Current Emission</label>
            <label class="tx-primary" id="emissionPercentPct"></label><br>
            <label class="tx-secondary" tkey="totalSupplyInfo">The total supply minted to date.</label>
            <h2><span id="totalCoins">N/A</span></h2>
          </div>
        </div> 
      </div>   
    </div>

    <div class="nav-statistics-wrapper">
      <nav class="nav">
<!--        <a href="" class="nav-link active" tkey="overview">Overview</a>  -->
      </nav>
    </div><!-- nav-statistics-wrapper -->

    <div class="row no-gutters row-statistics mg-b-30" id="networkDiffRow">
      <div class="dasboard-box">
        <h1 class="tx-white tx-56 tx-lato tx-bold"><span id="networkDifficulty">N/A</span></h1>
        <h6 class="tx-15 tx-primary tx-bold mg-b-20" tkey="netDifficulty">Network Difficulty</h6>
        <p tkey="netDiffInfo">Chart shows network difficulty for the last 30 blocks.</p>
        <a style="background-color: #222;border: 4px outset #ffef00;color:#ddd !important;border-radius:80px;/* border-image: url(/css/themes/gradi.gif) 15 stretch;*/" data-page="explorer.html" href="#explorer" class="statement-link" tkey="netExplorer">Explore Ledger<i
           class="fa fa-angle-right mg-l-5"></i></a>
        <p class="tx-12"></p>
      </div><!-- col-5 -->
      <div class="dasboard-box">
        <canvas id="diffAreaChart" height="280"></canvas>
      </div><!-- col-7 -->
    </div><!-- row -->

  
<hr>

<div class="report-summary-header">
  <div>
    <h4 class="tx-white mg-b-3" tkey="netOverallSummary">Overall Network Summary</h4>
  </div>
</div><!-- d-flex -->

<div class="card card-dash-one mg-t-20">
  <div class="row no-gutters">
    <div class="col-lg-3">
      <div class="dash-content">
        <label class="tx-primary" tkey="blockchainHeight">Blockchain Height</label>
        <h2><span id="networkHeight">N/A</span></h2>
      </div><!-- dash-content -->
    </div><!-- col-3 -->
    <div class="col-lg-3">
      <div class="dash-content dash-small-info">
        <label class="tx-primary" tkey="transactions">Transactions</label>
        <h2><span id="networkTransactions">N/A</span></h2>
      </div><!-- dash-content -->
    </div><!-- col-3 -->
    <div class="col-lg-3">
      <div class="dash-content dash-small-info">
        <label class="tx-primary" tkey="netHashrate">Network Hashrate</label>
        <h2><span id="networkHashrate">N/A</span></h2>
      </div><!-- dash-content -->
    </div><!-- col-3 -->
    <div class="col-lg-3">
      <div class="dash-content dash-small-info">
        <label class="tx-primary" tkey="totalBurned">Total Burned TEST </label>
        <h2><span id="totalBurned">N/A</span></h2>
      </div><!-- dash-content -->
    </div><!-- col-3 -->
  </div><!-- row -->
</div>

<!--    <div class="report-summary-header">
      <div>
        <h4 class="tx-white mg-b-3" tkey="miningInfo">Mining info</h4>
      </div>
    </div>

    <div class="card card-dash-one mg-t-20">
      <div class="row no-gutters">
        <div class="col-lg-4">
          <div class="dash-content">
            <label class="tx-primary" tkey="currentReward">Current block reward</label>
            <h2><span id="currentReward">N/A</span></h2>
          </div> 
        </div>
        <div class="col-lg-4">
          <div class="dash-content dash-small-info">
            <label class="tx-primary" tkey="numOfMiners">Number of Miners</label>
            <h2><span id="numOfMiners">N/A</span></h2>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="dash-content dash-small-info">
            <label class="tx-primary" tkey="sumPoolsHashrate">Pools speed</label>
            <h2><span id="sumPoolsHashrate">N/A</span></h2>
          </div>
        </div>
      </div> 
    </div>
 -->
    <hr>

    <div class="nav-statistics-wrapper mg-t-20">
      <nav class="nav">
        <a href="" class="nav-link active">Market Data  -  Powered by CoinGecko</a>
      </nav>
    </div><!-- nav-statistics-wrapper -->

    <!-- Statistics -->
    <div id="blockStats" class="card card-dash-one mg-b-20">
      <div class="row no-gutters">
        <div class="col-lg-3">
          <div class="dash-content dash-small-info dash-market">
            <div class="info-text">
              <label class="tx-primary" tkey="mktCCXToUSD">XFG to USD</label>
              <h2><span id="CCXToUSD">N/A</h2>
            </div>
            <div class="icon icon-info">
              <span class="fa fa-sm fa-dollar"></span>
            </div>
          </div><!-- dash-content -->
        </div><!-- col-3 -->
        <div class="col-lg-3">
          <div class="dash-content dash-small-info dash-market">
            <div class="info-text">
              <label class="tx-primary" tkey="mktCCXToBTC">XFG to BTC</label>
              <h2><span id="CCXToBTC">N/A</span></h2>
            </div>
            <div class="icon icon-info">
              <span class="fa fa-sm fa-btc"></span>
            </div>
          </div><!-- dash-content -->
        </div><!-- col-3 -->
        <div class="col-lg-3">
          <div class="dash-content dash-small-info dash-market">
            <div class="info-text">
              <label class="tx-primary" tkey="mktMarketcap">Marketcap</label><label class="tx-primary"
                id="marketcapRank"></label>
              <h2><span id="marketcap">N/A</span></h2>
            </div>
            <div class="icon icon-info">
              <span class="fa fa-sm fa-trophy"></span>
            </div>
          </div><!-- dash-content -->
        </div><!-- col-3 -->
        <div class="col-lg-3">
          <div class="dash-content dash-small-info dash-market">
            <div class="info-text">
              <label class="tx-primary" tkey="mktDailyVolume">Daily Volume</label>
              <h2><span id="dailyVolume">N/A</span></h2>
            </div>
            <div class="icon icon-info">
              <span class="fa fa-sm fa-money"></span>
            </div>
          </div><!-- dash-content -->
        </div><!-- col-3 -->
      </div><!-- row -->
    </div>

    <div id="chartMarketPrice">
      <canvas style="height:300px;" id="chartMarketPriceCanvas"></canvas>
      <a class="chart-style"></a>
    </div>

    <!-- Mining Profit Calculator -->

  </div><!-- container -->
</div><!-- slim-mainpanel -->

<script>
  var block = null;
  var USDperCCX = null;
  var diffAreaChart = null;
  var marketPriceAreaChart = null;
  var xhrGetBurnedTotal = null; // Add this for burned total requests

  // Automatically update profit calculation on key press
  $('#calcHashRate').keyup(calcEstimateProfit).change(calcEstimateProfit);

  // Click on button
  $('#calcHashUnits > li > a').click(function (e) {
    e.preventDefault();
    $('#calcHashUnit').text($(this).text()).data('mul', $(this).data('mul'));
    calcEstimateProfit();
  });

// Function to fetch burned total
function loadBurnedTotal() {
  if (xhrGetBurnedTotal) xhrGetBurnedTotal.abort();
  xhrGetBurnedTotal = $.ajax({
    url: api + '/json_rpc',
    method: "POST",
    data: JSON.stringify({
      jsonrpc: "2.0",
      id: "burned_total",
      method: "getTotalBurnedXfg",
      params: {}
    }),
    dataType: 'json',
    cache: 'false',
    success: function(data) {
      if (data && data.result) {
        // Update the burned total display
        var formattedAmount = data.result.formattedAmount || 
                             (getReadableCoins2(data.result.totalBurnedXfg || 0, 0));
        updateText('totalBurned', formattedAmount);
      }
    },
    error: function(xhr, status, error) {
      // Only log actual errors, not aborts
      if (error !== 'abort') {
        console.log('Error fetching burned total:', error);
      }
      updateText('totalBurned', 'N/A');
    }
  });
}



  function initializePoolData() {
    $.getJSON(poolListUrl, function (data, textStatus, jqXHR) {
      var totalHashrate = 0;
      var totalMiners = 0;

      data.forEach(function (element) {
        totalHashrate += element.pool.hashrate;
        totalMiners += element.pool.miners;
      });

      updateText('sumPoolsHashrate', getReadableHashRateString(totalHashrate));
      updateText('numOfMiners', localizeNumber(totalMiners));
    });
  }

  // Calculate current estimation
  function calcEstimateProfit() {
    try {
      var rateUnit = Math.pow(1000, parseInt($('#calcHashUnit').data('mul')));
      var hashRate = parseFloat($('#calcHashRate').val()) * rateUnit;
      var profit = (hashRate * 86400 / lastStats.difficulty) * lastStats.last_block_reward;
      if (profit) {
        var actualCoins = getReadableCoins(profit, 2, true);
        updateText('calcHashAmount1', actualCoins);
        updateText('calcHashAmount2', getCurrencyPriceText(actualCoins));
        return;
      }
    }
    catch (e) { }
    updateText('calcHashAmount1', '');
    updateText('calcHashAmount2', '');
  }

  // Get price in specified currency
  function getCurrencyPriceText(coinAmmount) {
    if (USDperCCX) {
      var price = USDperCCX * coinAmmount;
      return ("($ " + price.toFixed(2) + ")");
    }
  }

  currentPage = {
    destroy: function () {
    },
    init: function () {
      $("#currentDate").html("Today is: " + moment().format('MMMM Do YYYY'));
      initializePoolData();
      loadTranslations();

      // Load burned total on init
      loadBurnedTotal();

      $.ajax({
        url: api + '/json_rpc',
        method: "POST",
        data: JSON.stringify({
          jsonrpc: "2.0",
          id: "test",
          method: "f_blocks_list_json",
          params: {
            height: lastStats.last_known_block_index
          }
        }),
        dataType: 'json',
        cache: 'false',
        success: function (data) {
          renderDiffChart(data.result.blocks);
        }
      });
     

      // get market data
      $.getJSON("https://api.coingecko.com/api/v3/coins/fango?sparkline=true", function (data) {
        USDperCCX = data.market_data.current_price.usd;
        $("#CCXToUSD").html("$ " + localizeNumber(data.market_data.current_price.usd.toFixed(4)));
        $("#CCXToBTC").html(data.market_data.current_price.btc.toFixed(8));
        $("#dailyVolume").html("$ " + localizeNumber(data.market_data.total_volume.usd.toFixed(0)));

        if (marketPriceAreaChart) {
          marketPriceAreaChart.destroy();
        }
    
        var timeLabels = [];
        var dataLength = data.market_data.sparkline_7d.price.length;
        var durationAsMS = moment.duration(7 / dataLength, 'd').asMilliseconds();

        for (i = dataLength - 1; i >= 0; i--) {
          timeLabels.push(moment().subtract(durationAsMS * (i + 1), 'ms').format('YYYY-MM-DD'));
        }

        marketPriceAreaChart = new Chart(document.getElementById('chartMarketPriceCanvas'), {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [{
              data: smooth(data.market_data.sparkline_7d.price, 3),
              backgroundColor: '#42380040',
              fill: true,
              borderWidth: 0,
              pointRadius: 1,
              borderColor: 'rgb(70, 41, 255)'
            }]
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            legend: {
              display: false,
              labels: {
                display: false
              }
            },
            scales: {
              yAxes: [{
                ticks: {
                  maxTicksLimit: 5,
                  fontSize: 10,
                  callback: function (value, index, values) {
                    return '$' + value.toFixed(3);
                  }
                },
                gridLines: {
                  color: 'rgba(255,255,255,.08)'
                }
              }],
              xAxes: [{
                ticks: {
                  autoSkip: true,
                  maxTicksLimit: 7,
                  maxRotation: 0,
                  minRotation: 0
                },
                gridLines: {
                  color: 'rgba(255, 255, 255, .08)'
                },
              }]
            },
            hover: {
              mode: 'nearest',
              intersect: true
            },
            tooltips: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function (tooltipItem) {
                  return "$ " + Number(tooltipItem.yLabel).toFixed(4);
                }
              }
            }
          }
        });
      });
    },
    update: function () {
      renderLastBlock();
      updateText('networkHeight', localizeNumber(lastStats.height.toString()));
      updateText('networkTransactions', localizeNumber(lastStats.tx_count.toString()));
      updateText('networkHashrate', getReadableHashRateString(lastStats.difficulty / blockTargetInterval));
      updateText('networkDifficulty', getReadableDifficultyString(lastStats.difficulty, 0));
      
      // Refresh burned total on update
      loadBurnedTotal();
      
      $("time.timeago").timeago();
    }
  };

  function renderLastBlock() {
    $.getJSON("http://127.0.0.1:28280/getinfo", function (infoData) {
      updateText('totalBanked', getReadableCoins2(infoData.full_deposit_amount, 0));

      $.ajax({
        url: api + '/json_rpc',
        method: "POST",
        data: JSON.stringify({
          jsonrpc: "2.0",
          id: "test",
          method: "getlastblockheader",
          params: {}
        }),
        dataType: 'json',
        cache: 'false',
        success: function (data) {
          last_block_hash = data.result.block_header.hash;
          last_block_deposts = data.result.block_header.deposits;
          $.ajax({
            url: api + '/json_rpc',
            method: "POST",
            data: JSON.stringify({
              jsonrpc: "2.0",
              id: "test",
              method: "f_block_json",
              params: {
                hash: last_block_hash
              }
            }),
            dataType: 'json',
            cache: 'false',
            success: function (data) {
              var block = data.result.block;
              var circulating_supply = block.alreadyGeneratedCoins - last_block_deposts;
              var circulating_supply_pct = ((circulating_supply / block.alreadyGeneratedCoins) * 100).toFixed(2);
              var last_block_deposts_pct = ((last_block_deposts / block.alreadyGeneratedCoins) * 100).toFixed(2);
              updateText('totalCoins', getReadableCoins2(block.alreadyGeneratedCoins, 0));
              updateText('emissionPercent', getReadableCoins2(circulating_supply, 0));
              updateText('emissionPercentPct', "(" + circulating_supply_pct + "%)");
              updateText('currentReward', getReadableCoins(block.baseReward, 2));
              updateText('depositCoins', getReadableCoins2(last_block_deposts, 0));
              updateText('depositCoinsPct', "(" + last_block_deposts_pct + "%)");

            }
          });
        }
      });
    });
  }

  function renderDiffChart(blocksData) {
    var diffData = [];
    var labelData = [];

    for (i = 0; i < blocksData.length; i++) {
      diffData.push(blocksData[i].difficulty);
      labelData.push(moment.unix(blocksData[i].timestamp).format("hh:mm:ss"));
    }

    if (diffAreaChart) {
      diffAreaChart.destroy();
    }

    diffAreaChart = new Chart(document.getElementById('diffAreaChart'), {
      type: 'bar',
      data: {
        labels: labelData,
        datasets: [{
          data: smooth(diffData, 2),
          backgroundColor: 'rgb(70, 41, 255)',
          fill: true,
          borderWidth: 0,
          borderColor: 'rgb(70, 41, 255)'
        }]
      },
      options: {
        maintainAspectRatio: false,
        legend: {
          display: false,
          labels: {
            display: false
          }
        },
        scales: {
          yAxes: [{
            ticks: {
              maxTicksLimit: 5,
              beginAtZero: true,
              fontSize: 10
            },
            gridLines: {
              color: 'rgba(255,255,255,.08)'
            }
          }],
          xAxes: [{
            ticks: {
              beginAtZero: true,
              fontSize: 11
            },
            gridLines: {
              color: 'rgba(255,255,255,.08)'
            }
          }]
        }
      }
    });
  }
</script>

